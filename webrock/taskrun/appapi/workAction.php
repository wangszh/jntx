<?php
/**
	*****************************************************************
	* 联系QQ：290802026/1073744729									*
	* QQ  群：429403774，提供技术交流等								*
	* 版  本：V2.2+													*
	* 开发者：RockOA研发中心/雨中磐石工作室							*
	* 邮  箱：admin@rockoa.com										*
	* 网  址：http://www.rockoa.com/								*
	* 说  明: 核心代码/或者在线安装代码								*
	* 备  注: 未经允许不得商业出售，代码欢迎参考纠正				*
	* 修改时: 2016-05-09 20:15:43									*	
	*****************************************************************
*/
 class workClassAction extends appapiAction{public function getcansAjax(){$worktype = $this->option->getmnum('worktype','name');$workgrade = $this->option->getmnum('workgrade','name');$where= m('admin')->getjoinstr('runuserid', $this->adminid);$rors = m('projectm')->getall('id>0 '.$where.'','state,progress,title,id,startdt,runuserid','startdt desc');$rows = array();foreach($rors as $k=>$rs){$rows[] = array('id' => $rs['id'],'name' => $rs['title'].'('.$rs['state'].''.$rs['progress'].'%)');}$this->showreturn(array('type'=> $worktype,'grade' => $workgrade,'project'=> $rows));}public function getdataAjax(){$page= (int)$this->request('page','1');$protype= (int)$this->request('atype','0');$uid = $this->adminid;$s = $this->rock->dbinstr('distid', $uid);$dt = $this->date;$dbwok= m('work');if($protype ==0){$s.= " and ".$dbwok->getwwcwork($uid, 2);}if($protype ==1){$s.= " and ((`dt`='$dt') or (`dt`<'$dt' and `state` in('待执行','执行中')))";}if($protype ==2){$s = $this->rock->dbinstr('baoid', $uid);}if($protype ==3){$s = "`optid`=$uid";}if($protype ==4){}$fen = 5;$count = $this->db->rows("[Q]work", "id>0 and $s");$sql= "select `id`,`type`,`title`,`state`,`startdt`,`enddt`,`dist`,`grade`,`baoname`,`bgtime`,`explain`,`optname` from `[Q]work` where id>0 and $s order by `startdt` desc limit ".(($page-1)*$fen).",".$fen."";$rows = $this->db->getall($sql);$dtc = c('date');foreach($rows as $k=>$rs){$zt = $rs['state'];$zts = $rs['state'];if($this->contain($zt,'执行中')){$zt = '<font color="#ff6600">'.$zt.'</font>';}if($zt=='已完成'){$zt = '<font color="green">'.$zt.'</font>';}if(!$this->isempt($rs['enddt']) &&  ($zts=='待执行'||$zts=='执行中')){$sjla = $dtc->diffstr($this->now, $rs['enddt'], 'd天H时i分', 1); $sjsj = $dtc->datediff('i', $rs['enddt'],$this->now);if($sjsj>0)$zt.='<font color="red">超'.$sjla.'</font>';}$rows[$k]['state'] = $zt;}$maxpage= ceil($count/$fen);$wwctotal= $dbwok->getwwctotal($uid);$this->showreturn(array('rows'=> $rows,'count' => $count,'maxpage' => $maxpage,'page' => $page,'wwctotal'=> $wwctotal));}public function xiangAjax(){$mid = $this->get('mid');$rs = m('work')->getone("`id`='$mid'");$dtc = c('date');$zt = $rs['state'];$zts = $rs['state'];if($this->contain($zt,'执行中')){$zt = '<font color="#ff6600">'.$zt.'</font>';}if($zt=='已完成'){$zt = '<font color="green">'.$zt.'</font>';}if(!$this->isempt($rs['enddt']) && ($zts=='待执行'||$zts=='执行中')){$sjla = $dtc->diffstr($this->now, $rs['enddt'], 'd天H时i分', 1); $sjsj = $dtc->datediff('i', $rs['enddt'],$this->now);if($sjsj>0)$zt.='<font color="red">超'.$sjla.'</font>';}$rs['zt'] = $zt;$rs['logarr'] = m('workbg')->getall("mid='$mid' order by id desc", '`state`,`explain`,`optdt`,`optname`');$isbg  = 0;if($this->contain(','.$rs['distid'].',',','.$this->adminid.','))$isbg = 1;$rs['isbg'] = $isbg;$this->showreturn($rs);}public function savebgAjax(){$mid = $this->post('mid');$state = $this->post('state');$sm = $this->post('explain');$arr = array('mid' => $mid,'state' => $state,'explain' => $sm,'optdt' => $this->now,'optid' => $this->adminid,'optname' => $this->adminname);m('workbg')->insert($arr);m('work')->sendbaogao($mid, $state);$this->showreturn('保存成功');}public function saveworkAjax(){$arr = array('title' => $this->getvals('title'),'type' => $this->getvals('type'),'grade' => $this->getvals('grade'),'dist' => $this->getvals('dist'),'distid' => $this->getvals('distid'),'startdt' => $this->getvals('startdt'),'enddt' => $this->getvals('enddt'),'explain' => $this->getvals('explain'),'baoname' => $this->getvals('baoname'),'baoid' => $this->getvals('baoid'),'projectid' => $this->getvals('projectid','0'),'status' => '1','state'  => '待执行','optdt'  => $this->now,'optid'  => $this->adminid,'optname'  => $this->adminname,);foreach($arr as $k=>$v){if($k=='enddt')break;if($this->isempt($v))$this->showreturn('',''.$k.' is empty',201);}m('work')->insert($arr);$mid = $this->db->insert_id();$this->filesave('work', $mid);$nr = m('work')->sendtodo($mid, '新增');$this->showreturn($nr);}public function saveapibgAjax(){$mid = $this->get('mid');$state  = $this->getvals('state');$sm  = $this->getvals('sm');m('work')->sendbaogaoss($mid, $state, $sm);$this->showreturn('');}}