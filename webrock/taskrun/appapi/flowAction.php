<?php
/**
	*****************************************************************
	* 联系QQ：290802026/1073744729									*
	* QQ  群：429403774，提供技术交流等								*
	* 版  本：V2.2+													*
	* 开发者：RockOA研发中心/雨中磐石工作室							*
	* 邮  箱：admin@rockoa.com										*
	* 网  址：http://www.rockoa.com/								*
	* 说  明: 核心代码/或者在线安装代码								*
	* 备  注: 未经允许不得商业出售，代码欢迎参考纠正				*
	* 修改时: 2016-05-09 20:15:27									*	
	*****************************************************************
*/
 class flowClassAction extends appapiAction{public function daibanAjax(){$dbs = m('daiban');$rows = $dbs->dai($this->adminid, ',', 10);$this->showreturn(array('totalCount'=> $dbs->totaldaiban($this->adminid),'rows'=> $rows));}public function flowmodelistAjax(){$rows = m('flow_set')->getall("`isapp`=1 order by `sort`", '`num`,`name`,`type`,`sort`');$this->showreturn($rows);}public function checkAjax(){$flownum= $this->request('flownum');$id= (int)$this->request('id');$zt= (int)$this->request('zt');$sm= $this->rock->jm->base64decode($this->request('sm'));$flow = f($flownum);$flow->adminid = $this->adminid;$flow->adminname = $this->adminname;$flow->initrecord($id);$msg =  $flow->check($zt, $sm, $this->adminid);$this->showreturn($msg);}public function listcheckAjax(){$page= (int)$this->request('page','1');$protype= (int)$this->request('atype','0');$uid = $this->adminid;$s = "and a.`uid`='$uid'";if($protype ==1){$s ="and ".$this->rock->dbinstr('a.allcheckid', $uid);}if($protype ==2){$s ="and instr(b.superpath, '[$uid]')>0";}if($protype ==3){$s .= " and a.`nstatus`=2";}if($protype ==4){$s .= " and a.`nstatus`=0";}$fen = 10;$table= '[Q]flow_bill a left join [Q]admin b on a.uid=b.id ';$count = $this->db->rows($table, "a.`id`>0 and a.`isdel`=0 $s");$sql= "select a.*,b.`name`,b.`deptname` from $table where a.`id`>0 and a.`isdel`=0 $s order by a.optdt desc limit ".(($page-1)*$fen).",".$fen."";$rudlog= m('flowlog');$rows = $this->db->getall($sql);$mid= '0';$rudb = m('flow_course');foreach($rows as $k=>$rs){$mid.=','.$rs['modeid'];}$marr = m('flow_set')->getall("id in($mid)", '`num`,`summary`,`table`,`id`');$_marr= array();foreach($marr as $k=>$rs){$_marr[$rs['id']] = $rs;}foreach($rows as $k=>$rs){$rs1  = m($rs['table'])->getone($rs['mid']);$zt= '<font color=#888888>记录不存在</font>';$summary= '';$modenum= '';if($rs1){$zt = $rudb->getstatuss($rs['table'], $rs1);$moders = $_marr[$rs['modeid']];$summary= $moders['summary'];$summary= $this->rock->reparr($summary, $rs1);$modenum= $moders['num'];}$rows[$k]['statustext'] = $zt;$rows[$k]['modenum'] = $modenum;$rows[$k]['summary'] = $summary;}$maxpage= ceil($count/$fen);$this->showreturn(array('rows'=> $rows,'count' => $count,'maxpage' => $maxpage,'page' => $page,));}public function xiangAjax(){$table= $this->get('tablename');$modenum= $this->get('modenum');$mid= $this->get('mid');$uid = $this->adminid;$msg = '';$dbs = m('flowlog');$modenum= $dbs->getmodenum($table, $mid, $modenum);if($modenum == '' || $mid=='')$this->showreturn('','not found data',202);$flow = f($modenum);$flow->initrecord($mid, 1);if(!$flow->rs)$this->showreturn('','记录不存在',203);$table = $flow->table;$arr= $dbs->getdatalog($modenum, $table, $mid, $uid);$data = $arr['data'];foreach($flow->rs as $k=>$v)$data[$k]=$v;$arr['data']= $data;$arr['fields'] = $flow->getfields();$arr['file']= m('file')->getfile($table, $mid);$arr['inputrs']= m('flow_courseinput')->getall("`mid`='".$arr['inputid']."' and `mid`>0 order by `sort`");$arr['content']= $flow->contentview();$this->showreturn($arr);}public function flowdelAjax(){$id= (int)$this->get('mid', '0');$flownum= $this->get('modenum');$sm = $this->rock->jm->base64decode($this->request('sm'));$msg= '';if($id==0 || $flownum=='')$msg='sorry;';if($msg==''){$flow = f($flownum);$flow->adminid = $this->adminid;$flow->adminname = $this->adminname;$flow->initrecord($id);$msg = $flow->flowdelete($sm);}if($msg=='')$msg='success';$this->showreturn($msg);}}