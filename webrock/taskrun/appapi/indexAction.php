<?php
/**
	*****************************************************************
	* 联系QQ：290802026/1073744729									*
	* QQ  群：429403774，提供技术交流等								*
	* 版  本：V2.2+													*
	* 开发者：RockOA研发中心/雨中磐石工作室							*
	* 邮  箱：admin@rockoa.com										*
	* 网  址：http://www.rockoa.com/								*
	* 说  明: 核心代码/或者在线安装代码								*
	* 备  注: 未经允许不得商业出售，代码欢迎参考纠正				*
	* 修改时: 2016-05-09 20:15:30									*	
	*****************************************************************
*/
 class indexClassAction extends appapiAction{public function initindexAjax(){$uid = $this->adminid;$arr['msg']= '';$tos = m('admin')->rows("`id`='$uid' and `status`=1 and `type`=1 and `state`<>5");if($tos == 0){$arr['msg']= 'exit';}else{$daiban_total = m('daiban')->totaldaiban($uid);$todo_total = m('todo')->rows("`uid`='$uid' and `status`=0");$titles = array();$arr['total'] = array('daiban'=> $daiban_total,'todo'=> $todo_total);$time = time();$meetarr = m('meet')->getmeet($this->date, $uid);foreach($meetarr as $k=>$rs){if($time<$rs['endtime']){$titles['meet'] = '['.$rs['startdt'].']'.$rs['title'].'('.$rs['state'].')';break;}}$arr['total']['meet']= count($meetarr);$listcheck = m('flow_bill')->rows("`uid`='$uid' and `isdel`=0 and `nstatus`=2");$listchecks= '';if($listcheck>0)$listchecks = '<font color=red>处理未通过'.$listcheck.'条</font>';$titles['listcheck'] = $listchecks;$reimarr = m('reim')->getwdarr($uid);$reim_total = 0;foreach($reimarr as $k=>$rs){$reim_total+=$rs['stotal'];}$arr['total']['reim'] = $reim_total;$arr['reimarr']= $reimarr;$wecrto = m('work')->getwwctotal($uid);$work= '';if($wecrto>0)$work = '<font color=red>未完成'.$wecrto.'条</font>';$titles['work'] = $work;$arr['total']['work'] = m('work')->getwwcwork($uid, 1);$arr['titles'] = $titles;$arr['total']['gong'] = m('gong')->getwdto($this->adminid);}$this->showreturn($arr);}public function todoAjax(){$db= m('todo');$where  = "`uid`='$this->adminid' order by `status`,`id` desc limit 5";$wdto   = $db->rows("`uid`='$this->adminid' and `status`=0");if($wdto>0)$where  = "`uid`='$this->adminid' and `status`=0 order by `status`,`id` desc limit 10";$ids = '0';$rows = $db->getall($where,'`title`,`mess`,`status`,`optdt`,`id`,`table`,`mid`');foreach($rows as $k=>$rs){if($rs['status']==0)$ids .=','.$rs['id'];}if($ids!='0')$db->update("`status`=1","`id` in($ids)");$this->showreturn($rows);}public function getcardAjax(){$rows = m('admin')->getall("`status`=1 and `state`<>5 order by `sort`",'`id`,`name`,`face`,`ranking`,`deptname`,`mobile`,`email`,`tel`,`gender`,`deptid`');$arr['rows'] = $rows;$arr['imgroup'] = $this->getmygroup();$this->showreturn($arr);}public function getgroupAjax(){$arr = $this->getmygroup();$this->showreturn($arr);}private function getmygroup(){$rows = m('reim')->getgroup($this->adminid);return $rows;}public function initdataAjax(){$time= time();$uid= $this->adminid;$daibt = m('daiban')->totaldaiban($uid);$arr[]= array('title' => '单据待办','total'=> $daibt,'titles' => '','icon'=> 'Public/image/daibans.png','num'=> 'daiban','type'=> 'bs','id'=> '0');$meetarr = m('meet')->getmeet($this->date, $uid);$titles= '';foreach($meetarr as $k=>$rs){if($time<$rs['endtime']){$titles = '['.$rs['startdt'].']'.$rs['title'].'('.$rs['state'].')';break;}}$arr[]= array('title' => '今日会议','total'=> count($meetarr),'titles' => $titles,'icon'=> 'Public/image/meet.png','num'=> 'meet','type'=> 'bs','id'=> '0');$reimarr = m('reim')->getwdarr($uid);$inatar['user'] = '人员';$inatar['group'] = '群';$inatar['taolun'] = '讨论组';$inatar['system'] = '系统';$inatar['agent'] = '应用';$date = c('date');foreach($reimarr as $k=>$rs){$icon = $rs['face'];$type = $rs['type'];if($icon==''){$icon = 'Public/image/'.$rs['type'].'.png';}if($type!='agent')$arr[]= array('title' => $rs['name'],'total'=> $rs['stotal'],'titles' => 'REIM'.$inatar[$type].'信息,['.$date->stringdt($rs['optdt']).']','icon'=> $icon,'num'=> ''.$type.'_'.$rs['id'].'','type'=> $rs['type'],'id'=> $rs['id']);}$total = m('todo')->rows("`uid`='$uid' and `status`=0");$arr[]= array('title' => '站内提醒','total'=> $total,'titles' => '','icon'=> 'Public/image/tixings.png','num'=> 'todo','type'=> 'bs','id'=> '0');$total= m('gong')->getwdto($uid);$arr[]= array('title' => '通知公告','total'=> $total,'titles' => '','icon'=> 'Public/image/gong.png','num'=> 'gong','type'=> 'bs','id'=> '0');$total = m('work')->getwwctotal($uid);$arr[]= array('title' => '工作任务','total'=> $total,'titles' => '','icon'=> 'Public/image/renwu.png','num'=> 'work','type'=> 'bs','id'=> '0');if(m('log')->ismode(1)){$lars = m('emailin')->getlast($uid);$arr[]= array('title' => '内部邮件','total'=> $lars['stotal'],'titles' => '','icon'=> 'Public/image/emailin.png','num'=> 'emailin','type'=> 'bs','id'=> '0');}$this->showreturn($arr);}}